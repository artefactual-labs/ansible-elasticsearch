---
- name: "Install zip package"
  become: "yes"
  package:
    name: "zip"
    state: "present"

- name: "Check if JMSAppender.class has been removed"
  become: "yes"
  shell:
    cmd: "unzip -l log4j-*.jar | grep JMSAppender.class"
    chdir: "/usr/share/elasticsearch/lib"
    warn: no # This needs to be a cmd, and not the unzip module
  register: "__jmsappender_class"
  failed_when: "__jmsappender_class.rc not in [ 0, 1 ]"
  changed_when: __jmsappender_class.rc == 0 # Filename should be in output

- name: "Remove JMSAppender.class"
  become: "yes"
  shell:
    cmd: "zip -q -d log4j-*.jar org/apache/log4j/net/JMSAppender.class"
    chdir: "/usr/share/elasticsearch/lib"
  when:
    - "__jmsappender_class.rc == 0"
  notify: "Restart Elasticsearch"
